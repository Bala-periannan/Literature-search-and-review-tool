{% extends "base.html" %}
{% block content %}

<!-- 🔍 Search Section -->
<section class="search-box sticky-filters">
    <form action="{{ url_for('home') }}" method="post" class="search-form">
        
        <!-- Source Selector -->
        <label for="source">Select Source:</label>
        <select name="source" id="source" required>
            <option value="" disabled {% if not source %}selected{% endif %}>Select Source</option>
            <option value="pubmed" {% if source=='pubmed' %}selected{% endif %}>PubMed</option>
            <option value="crossref" {% if source=='crossref' %}selected{% endif %}>Crossref</option>
            <option value="springer" {% if source=='springer' %}selected{% endif %}>Springer</option>
            <option value="europepmc_publications" {% if source=='europepmc_publications' %}selected{% endif %}>Europe PMC - Publications</option>
            <option value="europepmc_grants" {% if source=='europepmc_grants' %}selected{% endif %}>Europe PMC - Grants</option>
            <option value="clinicaltrials" {% if source=='clinicaltrials' %}selected{% endif %}>ClinicalTrials.gov</option>
            <option value="doaj" {% if source=='doaj' %}selected{% endif %}>DOAJ</option>
        </select>

        <!-- Status Filter -->
        <div id="statusFilter" style="display: {% if source=='clinicaltrials' %}block{% else %}none{% endif %}; width:100%;">
            <label for="status">Status (optional):</label>
            <input type="text" id="status" name="status" placeholder="e.g., RECRUITING, COMPLETED" value="{{ status or '' }}">
        </div>

        <!-- Query Input -->
        <label for="query">Search Query:</label>
        <input type="text" id="query" name="query" placeholder="Enter keyword, DOI, or author" required value="{{ query or '' }}">

        <!-- 📅 Date Range -->
        <div class="date-range">
            <div>
                <label for="start_date">From:</label>
                <input type="date" id="start_date" name="start_date">
            </div>
            <div>
                <label for="end_date">To:</label>
                <input type="date" id="end_date" name="end_date">
            </div>
        </div>

        <!-- Search Button -->
        <div style="width:100%; text-align:center; margin-top:10px;">
            <button type="submit" class="search-btn">Search</button>
        </div>
    </form>
</section>

<!-- 📄 Results -->
{% if results %}
<section class="results-box">
    <h2>Search Results</h2>
    {% for article in results %}
    <div class="result-card">
        <h3>{{ article.title }}</h3>
        
        {% if article.abstract %}
            <p><strong>Abstract:</strong> {{ article.abstract }}</p>
        {% endif %}

        {% if article.authors %}
            <p><strong>Authors:</strong> {{ article.authors|join(', ') }}</p>
        {% endif %}

        {% if article.pmid %}
            <p><strong>PMID:</strong> {{ article.pmid }}</p>
        {% endif %}

        {% if article.doi %}
            <p><strong>DOI:</strong> {{ article.doi }}</p>
        {% endif %}

        <!-- Citation + Full Text -->
        <div class="link-section">
            {% if article.url %}
                <a href="{{ article.url }}" target="_blank" class="fulltext-link">Full Text</a>
            {% else %}
                <span class="fulltext-link disabled">Full Text N/A</span>
            {% endif %}

            {% if article.citation %}
                <a href="#" class="citation-link"
                   onclick="openCitationModal(`{{ article.citation|escape }}`, `{{ article.title|escape }}`, `{{ article.authors|join('; ')|escape }}`, `{{ article.year or '' }}`, `{{ article.doi or '' }}`)">
                   Cite this article
                </a>
            {% else %}
                <span class="citation-link disabled">Citation N/A</span>
            {% endif %}
        </div>
        <hr>
    </div>
    {% endfor %}
</section>
{% endif %}

<!-- 📱 Styles -->
<style>
/* Layout Fix */
.sticky-filters { 
    position: sticky; 
    top: 0; 
    background: #fff; 
    z-index: 10; 
    padding: 12px 1rem; 
    border-bottom: 1px solid #ccc; 
    max-width: 900px; 
    margin: auto;
}
.search-form { display: flex; flex-wrap: wrap; gap: 8px; }
.search-form label { width: 100%; font-weight: bold; margin-top: 5px; }
.search-form select, .search-form input { width: 100%; padding: 7px; border-radius: 5px; border: 1px solid #ccc; }
.date-range { display: flex; gap: 8px; width: 98%; }
.date-range div { flex: 1; }
.search-btn { background: #007acc; color: white; border-radius: 5px; border: none; padding: 10px; width: 40%; cursor: pointer; }
.search-btn:hover { background: #005ea3; }

.results-box {
    max-width: 900px;
    margin: 20px auto;
}
.result-card { 
    margin-bottom: 20px; 
    padding: 15px; 
    background: #f9f9f9; 
    border-radius: 12px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.link-section { display: flex; gap: 15px; align-items: center; }
.citation-link { text-decoration: underline; color: #007acc; cursor: pointer; }
.citation-link:hover { color: #005ea3; }

/* Popup */
.citation-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; }
.citation-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 10px; padding: 20px; width: 350px; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
.citation-modal h3 { margin-top: 0; text-align: center; }
.citation-modal button { margin-top: 8px; padding: 8px; width: 100%; border: none; border-radius: 5px; background: #007acc; color: white; cursor: pointer; }
.citation-modal button:hover { background: #005ea3; }
</style>

<!-- 📜 Popup -->
<div id="citationOverlay" class="citation-overlay" onclick="closeCitationModal()"></div>
<div id="citationModal" class="citation-modal">
    <h3>Citation Options</h3>
    <button id="copyCitationBtn">Copy Citation</button>
    <button onclick="triggerDownload('bibtex')">BibTeX</button>
    <button onclick="triggerDownload('ris')">RIS</button>
    <button onclick="triggerDownload('txt')">Plain Text</button>
    <button onclick="triggerDownload('xml_abs')">XML (Abstract)</button>
    <button onclick="triggerDownload('xml_full')">XML (Full Text)</button>
    <button style="background:#ccc; color:#000;" onclick="closeCitationModal()">Close</button>
</div>

<!-- 📜 Script -->
<script>
let currentCitation="", currentTitle="", currentAuthors="", currentYear="", currentDOI="";

function openCitationModal(citation, title, authors, year, doi) {
    currentCitation = citation;
    currentTitle = title;
    currentAuthors = authors;
    currentYear = year;
    currentDOI = doi;
    document.getElementById("citationOverlay").style.display = "block";
    document.getElementById("citationModal").style.display = "block";
}
function closeCitationModal() {
    document.getElementById("citationOverlay").style.display = "none";
    document.getElementById("citationModal").style.display = "none";
}
document.getElementById("copyCitationBtn").onclick = function() {
    navigator.clipboard.writeText(currentCitation)
        .then(()=>alert("Citation copied!"))
        .catch(()=>alert("Failed to copy citation"));
};

function triggerDownload(format) {
    let content="", filename="";
    if (format==="bibtex") {
        content=`@article{${currentAuthors.split(' ')[0]}_${currentYear},
  title={${currentTitle}},
  author={${currentAuthors}},
  year={${currentYear}},
  doi={${currentDOI}}
}`;
        filename="citation.bib";
    }
    else if (format==="ris") {
        content=`TY  - JOUR
TI  - ${currentTitle}
AU  - ${currentAuthors}
PY  - ${currentYear}
DO  - ${currentDOI}
ER  -`;
        filename="citation.ris";
    }
    else if (format==="txt") {
        content=`${currentAuthors} (${currentYear}). ${currentTitle}. DOI: ${currentDOI}`;
        filename="citation.txt";
    }
    else if (format==="xml_abs") {
        content=`<abstract>
<title>${currentTitle}</title>
<authors>${currentAuthors}</authors>
<year>${currentYear}</year>
<doi>${currentDOI}</doi>
<abstractText>${currentCitation}</abstractText>
</abstract>`;
        filename="citation_abstract.xml";
    }
    else if (format==="xml_full") {
        content=`<fulltext>
<title>${currentTitle}</title>
<authors>${currentAuthors}</authors>
<year>${currentYear}</year>
<doi>${currentDOI}</doi>
<fullText>${currentCitation}</fullText>
</fulltext>`;
        filename="citation_full.xml";
    }
    const blob=new Blob([content],{type:"text/plain"});
    const link=document.createElement("a");
    link.href=URL.createObjectURL(blob);
    link.download=filename;
    link.click();
    URL.revokeObjectURL(link.href);
}
</script>

{% endblock %}

